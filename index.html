<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBM Invoice System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .sidebar {
            background-color: var(--secondary-color);
            min-height: 100vh;
            color: white;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .alert-panel {
            border-left: 5px solid var(--warning-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .table th {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success-color);
        }
        
        .badge-warning {
            background-color: var(--warning-color);
        }
        
        .badge-danger {
            background-color: var(--danger-color);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse bg-dark" id="sidebarMenu">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">EBM System</h4>
                        <hr class="bg-light">
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="dashboard-tab">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="invoice-tab">
                                <i class="bi bi-receipt"></i> Create Invoice
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="stock-tab">
                                <i class="bi bi-box-seam"></i> Stock Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="reports-tab">
                                <i class="bi bi-file-earmark-bar-graph"></i> VAT Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="alerts-tab">
                                <i class="bi bi-exclamation-triangle"></i> Compliance Alerts
                                <span class="badge bg-danger rounded-pill float-end" id="alert-count">0</span>
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <a class="nav-link" href="#" id="settings-tab">
                                <i class="bi bi-gear"></i> Settings
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <!-- Dashboard Section -->
                <div id="dashboard-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
                                <span data-feather="calendar"></span> This week
                            </button>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-white bg-primary">
                                <div class="card-body">
                                    <h5 class="card-title">Today's Sales</h5>
                                    <h2 class="card-text" id="today-sales">Rwf 0</h2>
                                    <p class="card-text"><small>Last updated 5 mins ago</small></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-success">
                                <div class="card-body">
                                    <h5 class="card-title">This Month</h5>
                                    <h2 class="card-text" id="month-sales">Rwf 0</h2>
                                    <p class="card-text"><small>Last updated 1 hour ago</small></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-warning">
                                <div class="card-body">
                                    <h5 class="card-title">Low Stock Items</h5>
                                    <h2 class="card-text" id="low-stock-count">0</h2>
                                    <p class="card-text"><small>Items needing restock</small></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Invoices -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Recent Invoices</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Date</th>
                                            <th>Customer</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-invoices">
                                        <!-- Filled by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoice Creation Section -->
                <div id="invoice-section" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Create New Invoice</h1>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Invoice Items</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="item-select" class="form-label">Select Item</label>
                                            <select class="form-select" id="item-select">
                                                <option value="">-- Select Item --</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="item-quantity" class="form-label">Quantity</label>
                                            <input type="number" class="form-control" id="item-quantity" min="1" value="1">
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" id="add-item-btn">Add Item</button>
                                        </div>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Item</th>
                                                    <th>Price</th>
                                                    <th>Qty</th>
                                                    <th>Total</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invoice-items">
                                                <!-- Filled by JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Invoice Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="customer-name" class="form-label">Customer Name</label>
                                        <input type="text" class="form-control" id="customer-name" placeholder="Optional">
                                    </div>
                                    <div class="mb-3">
                                        <label for="customer-tin" class="form-label">Customer TIN</label>
                                        <input type="text" class="form-control" id="customer-tin" placeholder="Optional">
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span id="invoice-subtotal">Rwf 0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>VAT (18%):</span>
                                        <span id="invoice-vat">Rwf 0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between fw-bold fs-5">
                                        <span>Total:</span>
                                        <span id="invoice-total">Rwf 0.00</span>
                                    </div>
                                    <hr>
                                    <button class="btn btn-success w-100" id="generate-invoice-btn">Generate Invoice</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Management Section -->
                <div id="stock-section" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Stock Management</h1>
                        <button class="btn btn-primary" id="add-stock-btn">Add New Item</button>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Current Stock</h5>
                            <div class="input-group" style="width: 300px;">
                                <input type="text" class="form-control" placeholder="Search items..." id="stock-search">
                                <button class="btn btn-outline-secondary" type="button">Search</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Item Code</th>
                                            <th>Item Name</th>
                                            <th>Category</th>
                                            <th>Price</th>
                                            <th>In Stock</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stock-items">
                                        <!-- Filled by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Add/Edit Stock Modal -->
                    <div class="modal fade" id="stockModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="stockModalTitle">Add New Item</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="stock-form">
                                        <input type="hidden" id="edit-item-id">
                                        <div class="mb-3">
                                            <label for="item-code" class="form-label">Item Code</label>
                                            <input type="text" class="form-control" id="item-code" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="item-name" class="form-label">Item Name</label>
                                            <input type="text" class="form-control" id="item-name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="item-category" class="form-label">Category</label>
                                            <select class="form-select" id="item-category" required>
                                                <option value="General">General</option>
                                                <option value="Electronics">Electronics</option>
                                                <option value="Food">Food</option>
                                                <option value="Clothing">Clothing</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="item-price" class="form-label">Unit Price (Rwf)</label>
                                            <input type="number" class="form-control" id="item-price" min="0" step="0.01" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="item-quantity-stock" class="form-label">Quantity</label>
                                            <input type="number" class="form-control" id="item-quantity-stock" min="0" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="item-threshold" class="form-label">Low Stock Threshold</label>
                                            <input type="number" class="form-control" id="item-threshold" min="1" value="5">
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="save-stock-btn">Save Item</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VAT Reports Section -->
                <div id="reports-section" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">VAT Reports</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button class="btn btn-sm btn-outline-secondary" id="export-csv-btn">Export CSV</button>
                                <button class="btn btn-sm btn-outline-secondary" id="export-pdf-btn">Export PDF</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5>VAT Declaration Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="report-start-date" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="report-start-date">
                                </div>
                                <div class="col-md-4">
                                    <label for="report-end-date" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="report-end-date">
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="generate-report-btn">Generate Report</button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Invoice #</th>
                                            <th>Customer</th>
                                            <th>Taxable Amount</th>
                                            <th>VAT (18%)</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-data">
                                        <!-- Filled by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compliance Alerts Section -->
                <div id="alerts-section" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Compliance Alerts</h1>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card alert-panel">
                                <div class="card-header bg-warning text-white">
                                    <h5>Missing Invoices</h5>
                                </div>
                                <div class="card-body">
                                    <div id="missing-invoices-alerts">
                                        <!-- Filled by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card alert-panel">
                                <div class="card-header bg-danger text-white">
                                    <h5>Low Stock Items</h5>
                                </div>
                                <div class="card-body">
                                    <div id="low-stock-alerts">
                                        <!-- Filled by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>Compliance Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-success" id="compliance-status">
                                <i class="bi bi-check-circle-fill"></i> Your business is currently compliant with all tax regulations.
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill"></i> Remember to issue EBM invoices for all sales transactions as required by the Tax Procedure Law 2023.
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invoice #<span id="invoice-number-modal"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>From:</h6>
                            <p id="business-details">
                                <strong>Your Business Name</strong><br>
                                TIN: 123-456-789<br>
                                Address: 123 Business St, Dar es Salaam
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <h6>To:</h6>
                            <p id="customer-details-modal">
                                <strong>Walk-in Customer</strong><br>
                                TIN: Not provided
                            </p>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="invoice-items-modal">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill"></i> This is an official tax invoice. Please keep for your records.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="invoice-subtotal-modal">Rwf 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>VAT (18%):</span>
                                <span id="invoice-vat-modal">Rwf 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between fw-bold fs-5">
                                <span>Total:</span>
                                <span id="invoice-total-modal">Rwf 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="print-invoice-btn">Print Invoice</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all components
            initNavigation();
            initDashboard();
            initInvoiceSection();
            initStockSection();
            initReportsSection();
            initAlertsSection();
            
            // Load initial data
            loadInitialData();
            
            // Update alert count
            updateAlertCount();
        });

        // Navigation between sections
        function initNavigation() {
            const tabs = ['dashboard', 'invoice', 'stock', 'reports', 'alerts'];
            
            tabs.forEach(tab => {
                document.getElementById(`${tab}-tab`).addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Hide all sections
                    tabs.forEach(t => {
                        document.getElementById(`${t}-section`).style.display = 'none';
                        document.getElementById(`${t}-tab`).classList.remove('active');
                    });
                    
                    // Show selected section
                    document.getElementById(`${tab}-section`).style.display = 'block';
                    this.classList.add('active');
                });
            });
        }

        // Dashboard functionality
        function initDashboard() {
            // This would be expanded with more dashboard-specific functionality
        }

        // Invoice creation functionality
        function initInvoiceSection() {
            const itemSelect = document.getElementById('item-select');
            const addItemBtn = document.getElementById('add-item-btn');
            const invoiceItems = document.getElementById('invoice-items');
            const generateInvoiceBtn = document.getElementById('generate-invoice-btn');
            
            // Load items into select dropdown
            function loadItemsForInvoice() {
                itemSelect.innerHTML = '<option value="">-- Select Item --</option>';
                
                const stockItems = getStockItems();
                stockItems.forEach(item => {
                    if (item.quantity > 0) {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.name} (${item.price} Rwf) - ${item.quantity} available`;
                        itemSelect.appendChild(option);
                    }
                });
            }
            
            // Add item to invoice
            addItemBtn.addEventListener('click', function() {
                const itemId = itemSelect.value;
                const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
                
                if (!itemId) {
                    alert('Please select an item');
                    return;
                }
                
                const stockItems = getStockItems();
                const selectedItem = stockItems.find(item => item.id === itemId);
                
                if (quantity > selectedItem.quantity) {
                    alert(`Only ${selectedItem.quantity} items available in stock`);
                    return;
                }
                
                // Check if item already exists in invoice
                const existingRow = invoiceItems.querySelector(`tr[data-item-id="${itemId}"]`);
                
                if (existingRow) {
                    const existingQty = parseInt(existingRow.querySelector('.item-qty').textContent);
                    const newQty = existingQty + quantity;
                    
                    if (newQty > selectedItem.quantity) {
                        alert(`Only ${selectedItem.quantity} items available in stock`);
                        return;
                    }
                    
                    existingRow.querySelector('.item-qty').textContent = newQty;
                    existingRow.querySelector('.item-total').textContent = formatCurrency(newQty * selectedItem.price);
                } else {
                    const row = document.createElement('tr');
                    row.dataset.itemId = itemId;
                    
                    row.innerHTML = `
                        <td>${selectedItem.name}</td>
                        <td>${formatCurrency(selectedItem.price)}</td>
                        <td class="item-qty">${quantity}</td>
                        <td class="item-total">${formatCurrency(quantity * selectedItem.price)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger remove-item-btn">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    invoiceItems.appendChild(row);
                    
                    // Add event listener to remove button
                    row.querySelector('.remove-item-btn').addEventListener('click', function() {
                        row.remove();
                        updateInvoiceSummary();
                    });
                }
                
                updateInvoiceSummary();
            });
            
            // Update invoice summary (subtotal, VAT, total)
            function updateInvoiceSummary() {
                let subtotal = 0;
                
                document.querySelectorAll('#invoice-items .item-total').forEach(cell => {
                    subtotal += parseCurrency(cell.textContent);
                });
                
                const vat = subtotal * 0.18;
                const total = subtotal + vat;
                
                document.getElementById('invoice-subtotal').textContent = formatCurrency(subtotal);
                document.getElementById('invoice-vat').textContent = formatCurrency(vat);
                document.getElementById('invoice-total').textContent = formatCurrency(total);
            }
            
            // Generate invoice
            generateInvoiceBtn.addEventListener('click', function() {
                const customerName = document.getElementById('customer-name').value || 'Walk-in Customer';
                const customerTIN = document.getElementById('customer-tin').value || 'Not provided';
                const items = [];
                
                document.querySelectorAll('#invoice-items tr').forEach(row => {
                    items.push({
                        id: row.dataset.itemId,
                        name: row.cells[0].textContent,
                        price: parseCurrency(row.cells[1].textContent),
                        quantity: parseInt(row.cells[2].textContent),
                        total: parseCurrency(row.cells[3].textContent)
                    });
                });
                
                if (items.length === 0) {
                    alert('Please add items to the invoice');
                    return;
                }
                
                const subtotal = parseCurrency(document.getElementById('invoice-subtotal').textContent);
                const vat = parseCurrency(document.getElementById('invoice-vat').textContent);
                const total = parseCurrency(document.getElementById('invoice-total').textContent);
                
                // Create invoice
                const invoice = {
                    id: generateInvoiceId(),
                    date: new Date().toISOString(),
                    customerName,
                    customerTIN,
                    items,
                    subtotal,
                    vat,
                    total
                };
                
                // Save invoice
                saveInvoice(invoice);
                
                // Update stock
                updateStockAfterInvoice(items);
                
                // Show invoice modal
                showInvoiceModal(invoice);
                
                // Reset form
                invoiceItems.innerHTML = '';
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-tin').value = '';
                updateInvoiceSummary();
                
                // Reload dashboard to show new invoice
                loadDashboardData();
                updateAlertCount();
            });
            
            // Load items when invoice section is shown
            document.getElementById('invoice-tab').addEventListener('click', loadItemsForInvoice);
        }

        // Stock management functionality
        function initStockSection() {
            const stockItemsTable = document.getElementById('stock-items');
            const addStockBtn = document.getElementById('add-stock-btn');
            const saveStockBtn = document.getElementById('save-stock-btn');
            const stockModal = new bootstrap.Modal(document.getElementById('stockModal'));
            
            // Load stock items
            function loadStockItems() {
                stockItemsTable.innerHTML = '';
                
                const stockItems = getStockItems();
                
                if (stockItems.length === 0) {
                    stockItemsTable.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">No stock items found. Add your first item.</td>
                        </tr>
                    `;
                    return;
                }
                
                stockItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.dataset.itemId = item.id;
                    
                    const status = item.quantity === 0 ? 
                        '<span class="badge bg-danger">Out of Stock</span>' :
                        item.quantity <= item.threshold ? 
                        '<span class="badge bg-warning">Low Stock</span>' : 
                        '<span class="badge bg-success">In Stock</span>';
                    
                    row.innerHTML = `
                        <td>${item.code}</td>
                        <td>${item.name}</td>
                        <td>${item.category}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${item.quantity}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-stock-btn me-1">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-stock-btn">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    stockItemsTable.appendChild(row);
                    
                    // Add event listeners to buttons
                    row.querySelector('.edit-stock-btn').addEventListener('click', () => editStockItem(item.id));
                    row.querySelector('.delete-stock-btn').addEventListener('click', () => deleteStockItem(item.id));
                });
            }
            
            // Add new stock item
            addStockBtn.addEventListener('click', function() {
                document.getElementById('stockModalTitle').textContent = 'Add New Item';
                document.getElementById('stock-form').reset();
                document.getElementById('edit-item-id').value = '';
                stockModal.show();
            });
            
            // Edit stock item
            function editStockItem(itemId) {
                const stockItems = getStockItems();
                const item = stockItems.find(item => item.id === itemId);
                
                if (item) {
                    document.getElementById('stockModalTitle').textContent = 'Edit Item';
                    document.getElementById('edit-item-id').value = item.id;
                    document.getElementById('item-code').value = item.code;
                    document.getElementById('item-name').value = item.name;
                    document.getElementById('item-category').value = item.category;
                    document.getElementById('item-price').value = item.price;
                    document.getElementById('item-quantity-stock').value = item.quantity;
                    document.getElementById('item-threshold').value = item.threshold;
                    
                    stockModal.show();
                }
            }
            
            // Delete stock item
            function deleteStockItem(itemId) {
                if (confirm('Are you sure you want to delete this item?')) {
                    const stockItems = getStockItems().filter(item => item.id !== itemId);
                    localStorage.setItem('stockItems', JSON.stringify(stockItems));
                    loadStockItems();
                    updateAlertCount();
                }
            }
            
            // Save stock item
            saveStockBtn.addEventListener('click', function() {
                const form = document.getElementById('stock-form');
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                
                const itemId = document.getElementById('edit-item-id').value || generateId();
                const stockItems = getStockItems();
                
                const item = {
                    id: itemId,
                    code: document.getElementById('item-code').value,
                    name: document.getElementById('item-name').value,
                    category: document.getElementById('item-category').value,
                    price: parseFloat(document.getElementById('item-price').value),
                    quantity: parseInt(document.getElementById('item-quantity-stock').value),
                    threshold: parseInt(document.getElementById('item-threshold').value)
                };
                
                // Update or add item
                const existingIndex = stockItems.findIndex(i => i.id === itemId);
                if (existingIndex >= 0) {
                    stockItems[existingIndex] = item;
                } else {
                    stockItems.push(item);
                }
                
                localStorage.setItem('stockItems', JSON.stringify(stockItems));
                stockModal.hide();
                loadStockItems();
                updateAlertCount();
            });
            
            // Load stock items when stock section is shown
            document.getElementById('stock-tab').addEventListener('click', loadStockItems);
        }

        // Reports functionality
        function initReportsSection() {
            const generateReportBtn = document.getElementById('generate-report-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const reportData = document.getElementById('report-data');
            
            // Generate report
            generateReportBtn.addEventListener('click', function() {
                const startDate = document.getElementById('report-start-date').value;
                const endDate = document.getElementById('report-end-date').value;
                
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }
                
                const invoices = getInvoices().filter(invoice => {
                    const invoiceDate = new Date(invoice.date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setDate(end.getDate() + 1); // Include end date
                    
                    return invoiceDate >= start && invoiceDate <= end;
                });
                
                displayReportData(invoices);
            });
            
            // Display report data
            function displayReportData(invoices) {
                reportData.innerHTML = '';
                
                if (invoices.length === 0) {
                    reportData.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">No invoices found for the selected period</td>
                        </tr>
                    `;
                    return;
                }
                
                invoices.forEach(invoice => {
                    const row = document.createElement('tr');
                    
                    const date = new Date(invoice.date);
                    const formattedDate = date.toLocaleDateString();
                    
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${invoice.id}</td>
                        <td>${invoice.customerName}</td>
                        <td>${formatCurrency(invoice.subtotal)}</td>
                        <td>${formatCurrency(invoice.vat)}</td>
                        <td>${formatCurrency(invoice.total)}</td>
                    `;
                    
                    reportData.appendChild(row);
                });
            }
            
            // Export to CSV
            exportCsvBtn.addEventListener('click', function() {
                const startDate = document.getElementById('report-start-date').value;
                const endDate = document.getElementById('report-end-date').value;
                
                if (!startDate || !endDate) {
                    alert('Please generate a report first');
                    return;
                }
                
                const invoices = getInvoices().filter(invoice => {
                    const invoiceDate = new Date(invoice.date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setDate(end.getDate() + 1); // Include end date
                    
                    return invoiceDate >= start && invoiceDate <= end;
                });
                
                if (invoices.length === 0) {
                    alert('No data to export');
                    return;
                }
                
                let csv = 'Date,Invoice #,Customer,Taxable Amount,VAT (18%),Total\n';
                
                invoices.forEach(invoice => {
                    const date = new Date(invoice.date);
                    const formattedDate = date.toLocaleDateString();
                    
                    csv += `"${formattedDate}","${invoice.id}","${invoice.customerName}","${invoice.subtotal}","${invoice.vat}","${invoice.total}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `VAT_Report_${startDate}_to_${endDate}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            
            // Export to PDF (simulated)
            exportPdfBtn.addEventListener('click', function() {
                alert('PDF export functionality would be implemented with a library like jsPDF');
            });
            
            // Set default dates (current month)
            function setDefaultDates() {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                
                document.getElementById('report-start-date').valueAsDate = firstDay;
                document.getElementById('report-end-date').valueAsDate = lastDay;
            }
            
            // Set default dates when reports section is shown
            document.getElementById('reports-tab').addEventListener('click', setDefaultDates);
        }

        // Alerts functionality
        function initAlertsSection() {
            // This would be expanded with more alerts-specific functionality
        }

        // Helper functions for data management
        function loadInitialData() {
            // Initialize sample data if localStorage is empty
            if (!localStorage.getItem('stockItems')) {
                const sampleStock = [
                    {
                        id: generateId(),
                        code: 'ITEM-001',
                        name: 'Premium Sugar 1kg',
                        category: 'Food',
                        price: 2500,
                        quantity: 50,
                        threshold: 10
                    },
                    {
                        id: generateId(),
                        code: 'ITEM-002',
                        name: 'Cooking Oil 2L',
                        category: 'Food',
                        price: 8000,
                        quantity: 30,
                        threshold: 5
                    },
                    {
                        id: generateId(),
                        code: 'ITEM-003',
                        name: 'Rice 5kg',
                        category: 'Food',
                        price: 12000,
                        quantity: 20,
                        threshold: 5
                    },
                    {
                        id: generateId(),
                        code: 'ITEM-004',
                        name: 'Mobile Phone',
                        category: 'Electronics',
                        price: 350000,
                        quantity: 5,
                        threshold: 2
                    }
                ];
                
                localStorage.setItem('stockItems', JSON.stringify(sampleStock));
            }
            
            if (!localStorage.getItem('invoices')) {
                localStorage.setItem('invoices', JSON.stringify([]));
            }
            
            // Load dashboard data
            loadDashboardData();
        }
        
        function loadDashboardData() {
            const todaySales = document.getElementById('today-sales');
            const monthSales = document.getElementById('month-sales');
            const lowStockCount = document.getElementById('low-stock-count');
            const recentInvoices = document.getElementById('recent-invoices');
            
            // Calculate today's sales
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const invoices = getInvoices();
            const todayInvoices = invoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                return invoiceDate >= today;
            });
            
            const todayTotal = todayInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            todaySales.textContent = formatCurrency(todayTotal);
            
            // Calculate this month's sales
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthInvoices = invoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                return invoiceDate >= firstDayOfMonth;
            });
            
            const monthTotal = monthInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            monthSales.textContent = formatCurrency(monthTotal);
            
            // Count low stock items
            const stockItems = getStockItems();
            const lowStockItems = stockItems.filter(item => item.quantity > 0 && item.quantity <= item.threshold);
            lowStockCount.textContent = lowStockItems.length;
            
            // Show recent invoices (last 5)
            recentInvoices.innerHTML = '';
            const recent = [...invoices].reverse().slice(0, 5);
            
            if (recent.length === 0) {
                recentInvoices.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No recent invoices</td>
                    </tr>
                `;
                return;
            }
            
            recent.forEach(invoice => {
                const row = document.createElement('tr');
                const date = new Date(invoice.date);
                const formattedDate = date.toLocaleDateString();
                
                row.innerHTML = `
                    <td>${invoice.id}</td>
                    <td>${formattedDate}</td>
                    <td>${invoice.customerName}</td>
                    <td>${formatCurrency(invoice.total)}</td>
                    <td><span class="badge bg-success">Paid</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-invoice-btn" data-invoice-id="${invoice.id}">
                            <i class="bi bi-eye"></i> View
                        </button>
                    </td>
                `;
                
                recentInvoices.appendChild(row);
                
                // Add event listener to view button
                row.querySelector('.view-invoice-btn').addEventListener('click', function() {
                    showInvoiceModal(invoice);
                });
            });
        }
        
        function getStockItems() {
            return JSON.parse(localStorage.getItem('stockItems')) || [];
        }
        
        function getInvoices() {
            return JSON.parse(localStorage.getItem('invoices')) || [];
        }
        
        function saveInvoice(invoice) {
            const invoices = getInvoices();
            invoices.push(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
        }
        
        function updateStockAfterInvoice(items) {
            const stockItems = getStockItems();
            
            items.forEach(item => {
                const stockItem = stockItems.find(si => si.id === item.id);
                if (stockItem) {
                    stockItem.quantity -= item.quantity;
                }
            });
            
            localStorage.setItem('stockItems', JSON.stringify(stockItems));
        }
        
        function showInvoiceModal(invoice) {
            document.getElementById('invoice-number-modal').textContent = invoice.id;
            
            const customerDetails = `
                <strong>${invoice.customerName}</strong><br>
                TIN: ${invoice.customerTIN}
            `;
            document.getElementById('customer-details-modal').innerHTML = customerDetails;
            
            const invoiceItems = document.getElementById('invoice-items-modal');
            invoiceItems.innerHTML = '';
            
            invoice.items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.total)}</td>
                `;
                invoiceItems.appendChild(row);
            });
            
            document.getElementById('invoice-subtotal-modal').textContent = formatCurrency(invoice.subtotal);
            document.getElementById('invoice-vat-modal').textContent = formatCurrency(invoice.vat);
            document.getElementById('invoice-total-modal').textContent = formatCurrency(invoice.total);
            
            const invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            invoiceModal.show();
        }
        
        function updateAlertCount() {
            const stockItems = getStockItems();
            const lowStockItems = stockItems.filter(item => item.quantity > 0 && item.quantity <= item.threshold);
            
            document.getElementById('alert-count').textContent = lowStockItems.length;
            
            // Update alerts section if visible
            if (document.getElementById('alerts-section').style.display !== 'none') {
                updateAlertsSection();
            }
        }
        
        function updateAlertsSection() {
            const missingInvoicesAlerts = document.getElementById('missing-invoices-alerts');
            const lowStockAlerts = document.getElementById('low-stock-alerts');
            const complianceStatus = document.getElementById('compliance-status');
            
            // Check for missing invoices (simplified check)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const invoices = getInvoices();
            const todayInvoices = invoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                return invoiceDate >= today;
            });
            
            if (todayInvoices.length === 0) {
                missingInvoicesAlerts.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i> 
                        <strong>No invoices generated today!</strong> 
                        You must issue EBM invoices for all sales as required by law.
                    </div>
                `;
                
                complianceStatus.className = 'alert alert-danger';
                complianceStatus.innerHTML = `
                    <i class="bi bi-exclamation-triangle-fill"></i> 
                    Your business is currently <strong>not compliant</strong> with tax regulations. 
                    Generate invoices for all sales today.
                `;
            } else {
                missingInvoicesAlerts.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i> 
                        <strong>Good compliance!</strong> 
                        You've generated ${todayInvoices.length} invoice(s) today.
                    </div>
                `;
            }
            
            // Show low stock alerts
            const stockItems = getStockItems();
            const lowStockItems = stockItems.filter(item => item.quantity > 0 && item.quantity <= item.threshold);
            
            if (lowStockItems.length === 0) {
                lowStockAlerts.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i> 
                        <strong>Stock levels good!</strong> 
                        No items are currently low in stock.
                    </div>
                `;
            } else {
                let alertHtml = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i> 
                        <strong>${lowStockItems.length} item(s) low in stock:</strong>
                        <ul class="mt-2">
                `;
                
                lowStockItems.forEach(item => {
                    alertHtml += `<li>${item.name} (${item.quantity} remaining, threshold: ${item.threshold})</li>`;
                });
                
                alertHtml += `</ul></div>`;
                lowStockAlerts.innerHTML = alertHtml;
            }
        }
        
        // Utility functions
        function generateId() {
            return 'id-' + Math.random().toString(36).substr(2, 9);
        }
        
        function generateInvoiceId() {
            const now = new Date();
            const datePart = now.getFullYear().toString().substr(-2) + 
                           (now.getMonth() + 1).toString().padStart(2, '0') + 
                           now.getDate().toString().padStart(2, '0');
            const randomPart = Math.floor(1000 + Math.random() * 9000);
            return `INV-${datePart}-${randomPart}`;
        }
        
        function formatCurrency(amount) {
            return 'Rwf ' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        function parseCurrency(currencyString) {
            return parseFloat(currencyString.replace(/[^\d.-]/g, ''));
        }
    </script>
</body>
</html>